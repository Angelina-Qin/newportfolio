---
import ThemeToggle from './ThemeToggle.astro';
import Effect from "../effects/Effect.astro";
import {nav} from '../data/content';
import EffectSwitch from "../effects/EffectSwitch.astro";
import NavMobile from "../components/NavMobile.astro";


const normalize = (p = "") => String(p).replace(/\/+$/, ""); // 去掉末尾斜杠
const lastSegment = (p = "") => {
  const parts = normalize(p).split("/").filter(Boolean);
  return parts[parts.length - 1] || "";
};
const isActive = (href = "") =>
  lastSegment(Astro.url.pathname) === lastSegment(href);
---

<nav>
	<div class="container nav-wrapper">
		<div class="menu-header">
			<div class="site-title">
				<a href="/newportfolio/" class="author">
					<figure class="avatar">
						<img class="avatar__img"
							src={nav.avatar} alt=""
							draggable="false">
					</figure>
				</a>
				<EffectSwitch/>
			</div>
		</div>
		<div id="menu-content">
			<div class="menu-footer pc-nav">
				<ul class="nav-items">
					{nav.items?.map(item => (
						<li>
							<a
							  aria-current={isActive(item.href) ? 'page' : undefined}
							  class:list={[
								 'link',
								 { active: isActive(item.href) },
							  ]}
							  href={item.href}
							  target={item.target || '_self'}
							>
								{item.label}
							</a>
						</li>
					))}
				</ul>
				<div class="theme-toggle" style="transform:scale(0.75)">
					<ThemeToggle />
				</div>
			</div>
			<NavMobile/>
		</div>
	</div>
</nav>
<Effect/>

<script lang="ts">
  class MenuButton extends HTMLElement {
    constructor() {
      super();

      this.appendChild(this.querySelector('template')!.content.cloneNode(true));
      const btn = this.querySelector('button')!;
      const menu = document.getElementById('menu-content') as HTMLElement;

      // 默认收起
      menu.hidden = true;

      // 显式标注 boolean
      const setExpanded = (expand: boolean) => {
        btn.setAttribute('aria-expanded', expand ? 'true' : 'false');
        menu.hidden = !expand;
      };

      btn.addEventListener('click', () => setExpanded(menu.hidden));

      // 标注为 MediaQueryList | MediaQueryListEvent
      const handleViewports = (e: MediaQueryList | MediaQueryListEvent) => {
        const matches = 'matches' in e ? e.matches : (e as MediaQueryList).matches;
        setExpanded(matches);
        btn.hidden = matches;
      };

      const mediaQueries = window.matchMedia('(min-width: 50em)');
      handleViewports(mediaQueries);
      mediaQueries.addEventListener('change', handleViewports);
    }
  }
  customElements.define('menu-button', MenuButton);
</script>


<style>
	nav {
		z-index: 9999;
		position: sticky;
		top: 0;
		font-family: var(--font-brand);
		font-weight: 500;
		-webkit-backdrop-filter: saturate(300%) blur(5px);
		backdrop-filter: saturate(300%) blur(5px);
		background-color: rgba(var(--color-999-rgb), 0.65);
	}
	.bg-ticker{ position: absolute; left:0; right:0; bottom:0; top:-50px; width:100%; height:100%; z-index:-1; }

	.menu-header { display:flex; justify-content:space-between; gap: .5rem; padding:0; }
	.site-title { display:flex; gap:.5rem; align-items:center; color:var(--color-0); font-weight:400; text-decoration:none; font-size:1.5rem; letter-spacing:.1px; }
	.site-title:hover{ color:rgb(236,72,113); }
	.logo { max-height: 30px; }
	.logo path{ fill: var(--color-100); }

  .avatar{ display:inline-block; position:relative; line-height:1; width:40px; height:40px; border-radius:50%; }
	.avatar__img{ display:block; border-radius:50%; }
	.avatar__name{ line-height:normal; font-weight:400; font-size:22px; }

	.nav-wrapper{ display:flex; align-items:center; justify-content:space-between; gap:1rem; }
	.nav-items{
		margin:0; display:flex; flex-direction:row; align-items:center;
		font-size:1rem; font-weight:normal; line-height:1; list-style:none; padding:0;
		gap: calc(var(--gap)*1.5);
	}
	.nav-items li{ margin:0; }

	.link{ display:inline-block; color:var(--color-300); text-decoration:none; }
	.link.active{ color:var(--color-100); font-weight:bold; }

	.menu-footer{ --icon-size:var(--text-xl); --icon-padding:.5rem; display:flex; justify-content:space-between; gap:.75rem; padding:.35rem 0rem; }
	.socials{ display:flex; flex-wrap:wrap; gap:.625rem; font-size:var(--icon-size); }
	.social{ display:flex; padding:var(--icon-padding); text-decoration:none; color:var(--accent-dark); transition: color var(--theme-transition); }
	.social:hover,.social:focus{ color:var(--accent-text-over); }

	.theme-toggle{ display:flex; align-items:center; height: calc(var(--icon-size) + 2 * var(--icon-padding)); }
	.languages{ display:flex; align-items:center; height: calc(var(--icon-size) + 2 * var(--icon-padding)); }

	@media (min-width: 60em) {
		.socials { display:flex; justify-content:flex-end; gap:0; }
	}
	@media (max-width: 576px) {
		.nav-wrapper{ display:flex; align-items:center; gap:0rem; }
		.menu-header{ padding:8px 0; }
		.menu-footer{ padding:0; }
	}
	.pc-nav{ display:none; }
	@media (min-width: 767px) { .pc-nav{ display:flex; } }
</style>
